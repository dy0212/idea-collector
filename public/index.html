<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì•„ì´ë””ì–´ ë¬˜ì§€</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Nanum+Gothic&display=swap');

    body {
      font-family: 'Nanum Gothic', sans-serif;
      background: linear-gradient(to right, #f6f9fc, #e0eafc);
      color: #333;
      max-width: 800px;
      margin: 0 auto;
      padding: 30px;
      text-align: center;
    }

    h1 { font-size: 2.2rem; font-weight: bold; }

    .card {
      background: white;
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
      position: relative;
      text-align: left;
    }

    .delete-btn {
      position: absolute;
      top: 12px;
      right: 15px;
      cursor: pointer;
      font-size: 1.2em;
      color: #e74c3c;
    }

    input, textarea, button {
      font-family: inherit;
      font-size: 1rem;
      padding: 10px 12px;
      margin: 8px 0;
      border-radius: 8px;
      border: 1px solid #ccc;
      width: 100%;
      box-sizing: border-box;
    }

    button {
      background-color: #4e73df;
      color: white;
      border: none;
      cursor: pointer;
    }

    button:hover { background-color: #375ac2; }

    #userListModal {
      display: none;
      position: fixed;
      top: 10%;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      border: 1px solid #ccc;
      padding: 20px;
      z-index: 1000;
      max-height: 70vh;
      overflow-y: auto;
      border-radius: 12px;
    }

    #userListModal button { margin-left: 10px; }

    #explanationText {
      background: #fff;
      padding: 15px;
      text-align: left;
      border: 1px solid #ccc;
      border-radius: 8px;
      margin-bottom: 15px;
    }
  </style>
</head>
<body>
  <h1>ğŸª¦ ë²„ë ¤ì§„ ì•„ì´ë””ì–´ ëª¨ìŒ</h1>

  <div id="authSection">
    <form id="loginForm">
      <input type="text" id="username" placeholder="ì´ë©”ì¼" required>
      <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸" required>
      <button type="submit">ë¡œê·¸ì¸</button>
    </form>
    <button id="logoutBtn" style="display:none;">ë¡œê·¸ì•„ì›ƒ</button>
    <div id="welcomeMsg"></div>

    <button id="toggleRegisterBtn">íšŒì›ê°€ì…</button>

    <div id="registerSection" style="display:none;">
      <h3>íšŒì›ê°€ì…</h3>
      <form id="registerForm">
        <input type="text" id="reg_username" placeholder="ì´ë©”ì¼ ì£¼ì†Œ" required>
        <input type="password" id="reg_password" placeholder="ë¹„ë°€ë²ˆí˜¸" required>
        <div style="text-align: left; margin-top: 10px;">
  <div style="max-height: 150px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px; border-radius: 8px; background: #fafafa; font-size: 0.9em;">
    <strong>[ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš© ì•ˆë‚´]</strong><br><br>
    ë³¸ ì›¹ì‚¬ì´íŠ¸ëŠ” íšŒì›ê°€ì…ì„ ìœ„í•´ ë‹¤ìŒê³¼ ê°™ì€ ê°œì¸ì •ë³´ë¥¼ ìˆ˜ì§‘í•©ë‹ˆë‹¤.<br>
    1. ìˆ˜ì§‘ í•­ëª©: ì´ë©”ì¼ ì£¼ì†Œ, ë¹„ë°€ë²ˆí˜¸<br>
    2. ìˆ˜ì§‘ ëª©ì : ì‚¬ìš©ì ì‹ë³„ ë° ë¡œê·¸ì¸, ì•„ì´ë””ì–´ ì €ì¥ ê¸°ëŠ¥ ì œê³µ<br>
    3. ë³´ìœ  ë° ì´ìš© ê¸°ê°„: íšŒì› íƒˆí‡´ ì‹œê¹Œì§€<br>
    4. ì‚¬ìš©ìëŠ” ê°œì¸ì •ë³´ ì œê³µì„ ê±°ë¶€í•  ê¶Œë¦¬ê°€ ìˆìœ¼ë‚˜, ì´ ê²½ìš° íšŒì›ê°€ì…ì´ ì œí•œë©ë‹ˆë‹¤.
  </div>
  <label style="display: block; margin-top: 8px;">
    <input type="checkbox" id="reg_agree" required>
    ìœ„ ë‚´ìš©ì„ ëª¨ë‘ ì½ê³  ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš©ì— ë™ì˜í•©ë‹ˆë‹¤.
  </label>
</div>
        <button type="submit">íšŒì›ê°€ì…</button>
      </form>
    </div>

    <div id="verificationSection" style="display:none;">
      <h3>ì´ë©”ì¼ ì¸ì¦</h3>
      <input type="text" id="verify_code" placeholder="ì´ë©”ì¼ë¡œ ë°›ì€ ì¸ì¦ì½”ë“œ" required>
      <button id="verifyBtn">ì¸ì¦ ì™„ë£Œ</button>
    </div>
  </div>

  <div id="adminControls" style="display:none; margin-top: 10px;">
    <button onclick="showUserList()">ì‚¬ìš©ì ëª©ë¡ ë³´ê¸°</button>
  </div>

  <div id="userListModal">
    <h3>ì‚¬ìš©ì ëª©ë¡</h3>
    <ul id="userList"></ul>
    <button onclick="closeUserList()">X ë‹«ê¸°</button>
  </div>

  <div id="explanationContainer" style="display:none;">
    <button onclick="toggleExplanation()">ğŸ§ ì„¤ëª… ë³´ê¸°</button>
    <div id="explanationText" style="display:none;">
      <p><strong>ì´ ì›¹ì‚¬ì´íŠ¸ëŠ”?</strong><br>
        ë– ì˜¤ë¥¸ ì•„ì´ë””ì–´ë¥¼ ì €ì¥í–ˆë‹¤ê°€, ë‚˜ì¤‘ì— ë³´ë©´ "ì™œ ì´ê±¸ ì¼ì§€?" ì‹¶ì€ ì•„ì´ë””ì–´ë“¤ì„ ëª¨ì•„ë‘ëŠ” <em>ì•„ì´ë””ì–´ì˜ ë¬˜ì§€</em>ì…ë‹ˆë‹¤.</p>
      <p><strong>ì‚¬ìš©ë²•</strong><br>
        - ë¡œê·¸ì¸ í›„ ì•„ì´ë””ì–´ë¥¼ ì €ì¥<br>
        - ì €ì¥ëœ ì•„ì´ë””ì–´ëŠ” 'ì €ì¥ëœ ì•„ì´ë””ì–´ ë³´ê¸°' ë²„íŠ¼ìœ¼ë¡œ í™•ì¸<br>
        - ê´€ë¦¬ì(superadmin)ëŠ” ì‚¬ìš©ì ê´€ë¦¬ë„ ê°€ëŠ¥</p>
    </div>
  </div>

  <div id="inputSection" style="display:none;">
    <input type="text" id="title" placeholder="ì œëª©" maxlength="100"><br><br>
    <textarea id="description" placeholder="ë‚´ìš©" maxlength="500"></textarea><br><br>
    <button id="saveBtn">ì €ì¥í•˜ê¸°</button>
  </div>

  <div id="viewIdeasBtnContainer" style="display:none;">
    <button onclick="showIdeaPage()">ğŸ“‚ ì €ì¥ëœ ì•„ì´ë””ì–´ ë³´ê¸°</button>
  </div>

  <div id="ideaPage" style="display:none;">
    <h2>ğŸ“ ì €ì¥ëœ ì•„ì´ë””ì–´ë“¤</h2>
    <div id="ideaList"></div>
    <button onclick="hideIdeaPage()">â¬… ëŒì•„ê°€ê¸°</button>
  </div>

  <script>
    const API_BASE = window.location.origin;
    let tempRegister = {};
    let isAdmin = false;
    let isSuperAdmin = false;
    let currentUserId = null;

    document.getElementById('toggleRegisterBtn').addEventListener('click', () => {
      const regSection = document.getElementById('registerSection');
      regSection.style.display = regSection.style.display === 'none' ? 'block' : 'none';
    });

    document.getElementById('loginForm').addEventListener('submit', async e => {
      e.preventDefault();
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;


      try {
        const res = await fetch(`${API_BASE}/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ username, password })
        });
        if (!res.ok) throw new Error('ë¡œê·¸ì¸ ì‹¤íŒ¨');
        await fetchMe();
      } catch (err) {
        alert(err.message);
      }
    });

    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await fetch(`${API_BASE}/logout`, { method: 'POST', credentials: 'include' });
      location.reload();
    });

    document.getElementById('registerForm').addEventListener('submit', async e => {
      e.preventDefault();
      const username = document.getElementById('reg_username').value;
      const password = document.getElementById('reg_password').value;
      const agree = document.getElementById('reg_agree').checked;

      try {
        const res = await fetch(`${API_BASE}/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ username, password, agree })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'íšŒì›ê°€ì… ì‹¤íŒ¨');

        tempRegister = { verifyId: data.verifyId, username, password };
        registerSection.style.display = 'none';
        verificationSection.style.display = 'block';
        alert('ì´ë©”ì¼ë¡œ ì¸ì¦ì½”ë“œë¥¼ ë³´ëƒˆìŠµë‹ˆë‹¤.');
      } catch (err) {
        alert(err.message);
      }
    });

    document.getElementById('verifyBtn').addEventListener('click', async () => {
      const code = verify_code.value;
      try {
        const res = await fetch(`${API_BASE}/verify`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            verifyId: tempRegister.verifyId,
            code,
            username: tempRegister.username,
            password: tempRegister.password
          })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'ì¸ì¦ ì‹¤íŒ¨');
        alert('ì´ë©”ì¼ ì¸ì¦ ì™„ë£Œ! ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.');
        location.reload();
      } catch (err) {
        alert(err.message);
      }
    });

    document.getElementById('saveBtn').addEventListener('click', async () => {
      const titleInput = document.getElementById('title');
      const descriptionInput = document.getElementById('description');
      const title = titleInput.value.trim();
      const description = descriptionInput.value.trim();
      if (!title) return alert('ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.');
      try {
        await fetch(`${API_BASE}/ideas`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ title, description })
        });
        title.value = '';
        description.value = '';
        loadIdeas();
      } catch (err) {
        console.error(err);
      }
    });

    function toggleExplanation() {
      const text = document.getElementById('explanationText');
      text.style.display = text.style.display === 'none' ? 'block' : 'none';
    }

    async function fetchMe() {
      try {
        const res = await fetch(`${API_BASE}/me`, { credentials: 'include' });
        if (!res.ok) throw new Error();
        const data = await res.json();
        currentUserId = data.id;
        welcomeMsg.textContent = `${data.username}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤.`;
        loginForm.style.display = 'none';
        logoutBtn.style.display = 'inline';
        inputSection.style.display = 'block';
        viewIdeasBtnContainer.style.display = 'block';
        registerSection.style.display = 'none';
        toggleRegisterBtn.style.display = 'none';
        explanationContainer.style.display = 'block';

        isAdmin = data.role === 'admin' || data.role === 'superadmin';
        isSuperAdmin = data.role === 'superadmin';
        if (isAdmin) adminControls.style.display = 'block';
      } catch (err) {
        console.warn('ì‚¬ìš©ì ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨', err);
      }
    }

    function showIdeaPage() {
      ideaPage.style.display = 'block';
      inputSection.style.display = 'none';
      viewIdeasBtnContainer.style.display = 'none';
      loadIdeas();
    }

    function hideIdeaPage() {
      ideaPage.style.display = 'none';
      inputSection.style.display = 'block';
      viewIdeasBtnContainer.style.display = 'block';
    }

    async function loadIdeas() {
      try {
        const res = await fetch(`${API_BASE}/ideas`, { credentials: 'include' });
        const ideas = await res.json();
        ideaList.innerHTML = '';
        ideas.reverse().forEach(idea => {
          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `<strong>${idea.title}</strong><br>
                            <small>${new Date(idea.date).toLocaleString()}</small><br>
                            <div>${idea.description}</div>
                            <small>ì‘ì„±ì: ${idea.user?.username || 'ì•Œ ìˆ˜ ì—†ìŒ'}</small>`;

          if (isAdmin) {
            const delBtn = document.createElement('span');
            delBtn.className = 'delete-btn';
            delBtn.textContent = 'ğŸ—‘ï¸';
            delBtn.onclick = () => deleteIdea(idea.id);
            card.appendChild(delBtn);
          }

          ideaList.appendChild(card);
        });
      } catch (err) {
        console.error(err);
      }
    }

    async function deleteIdea(id) {
      if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      await fetch(`${API_BASE}/ideas/${id}`, {
        method: 'DELETE',
        credentials: 'include'
      });
      loadIdeas();
    }

    async function showUserList() {
      const res = await fetch(`${API_BASE}/users`, { credentials: 'include' });
      const users = await res.json();
      userList.innerHTML = '';
      users.forEach(user => {
        const li = document.createElement('li');
        li.textContent = `${user.username} (${user.role})`;

        if (isSuperAdmin && user.id !== currentUserId) {
          const btn = document.createElement('button');
          btn.textContent = 'ê¶Œí•œë³€ê²½';
          btn.onclick = () => changeUserRole(user.id);
          li.appendChild(btn);
        }

        if (isAdmin && user.id !== currentUserId) {
          const del = document.createElement('button');
          del.textContent = 'ì‚­ì œ';
          del.onclick = () => deleteUser(user.id);
          li.appendChild(del);
        }

        userList.appendChild(li);
      });
      userListModal.style.display = 'block';
    }

    function closeUserList() {
      userListModal.style.display = 'none';
    }

    async function changeUserRole(id) {
      await fetch(`${API_BASE}/users/${id}/role`, {
        method: 'PUT',
        credentials: 'include'
      });
      showUserList();
    }

    async function deleteUser(id) {
      if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      await fetch(`${API_BASE}/users/${id}`, {
        method: 'DELETE',
        credentials: 'include'
      });
      showUserList();
    }

    fetchMe(); // ìë™ ë¡œê·¸ì¸ ì‹œë„
  </script>
</body>
</html>
